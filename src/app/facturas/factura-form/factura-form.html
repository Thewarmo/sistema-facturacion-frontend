<mat-card>
  <mat-card-header>
    <mat-card-title>Nueva Factura</mat-card-title>
  </mat-card-header>
  
  <mat-card-content>
    <form [formGroup]="form" (ngSubmit)="guardar()">
      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
            <mat-label>Cliente</mat-label>
            <mat-select formControlName="cliente">
                <mat-option *ngFor="let cliente of clientes" [value]="cliente">
                {{ cliente.nombre }} {{ cliente.apellido }}
                </mat-option>
            </mat-select>
            <mat-error *ngIf="form.get('cliente')?.hasError('required')">
                El cliente es requerido
            </mat-error>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>MÃ©todo de Pago</mat-label>
          <mat-select formControlName="metodoPago">
            <mat-option *ngFor="let metodo of metodoPagoEnum | keyvalue" [value]="metodo.value">
              {{ metodo.value }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <mat-divider></mat-divider>
      
      <div class="detalles-section">
        <h3>Productos</h3>
        
        <div formArrayName="detalles">
          <mat-card *ngFor="let detalle of detalles.controls; let i = index" [formGroupName]="i" class="detalle-card">
            <mat-card-content>
              <div class="detalle-row">
                <mat-form-field appearance="outline" class="producto-field">
                  <mat-label>Producto</mat-label>
                  <mat-select formControlName="productoId">
                    <mat-option *ngFor="let prod of productos" [value]="prod.id">
                      {{ prod.nombre }} ({{ prod.precioUnitario | currency:'COP' }})
                    </mat-option>
                  </mat-select>
                  <mat-error *ngIf="detalle.get('productoId')?.hasError('required')">
                    El producto es requerido
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="cantidad-field">
                  <mat-label>Cantidad</mat-label>
                  <input matInput type="number" formControlName="cantidad" min="1">
                  <mat-error *ngIf="detalle.get('cantidad')?.hasError('required')">
                    La cantidad es requerida
                  </mat-error>
                  <mat-error *ngIf="detalle.get('cantidad')?.hasError('min')">
                    La cantidad debe ser mayor a 0
                  </mat-error>
                </mat-form-field>

                <button mat-icon-button color="warn" type="button" (click)="eliminarDetalle(i)" 
                        *ngIf="detalles.length > 1" class="delete-button">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <div class="add-product-section">
          <button mat-raised-button color="accent" type="button" (click)="agregarDetalle()">
            <mat-icon>add</mat-icon>
            Agregar Producto
          </button>
        </div>
      </div>

      <mat-divider></mat-divider>

      <div class="total-section">
        <h3>Total: {{ calcularTotal() | currency:'COP' }}</h3>
      </div>

      <div class="form-actions">
        <button mat-raised-button color="primary" type="submit" [disabled]="form.invalid">
          <mat-icon>save</mat-icon>
          Guardar Factura
        </button>
        <button mat-button type="button" routerLink="/dashboard/facturas">
          Cancelar
        </button>
      </div>
    </form>
  </mat-card-content>
</mat-card>

